# 스마트 모바일 프로그래밍_공공데이터를 이용한 의약품 정보 알림 서비스
## Abstract  
* 의약품 정보 알림 서비스 어플리케이션은 약의 모양 또는 이름으로 간편하게 검색기능을 구현하여 의약품의 알맞은 복용방법과 편리한 약 검색을 위한 서비스를 제공하고, 약 복용시간 알림으로 정확한 시간에 약을 복용할 수 있도록한다. 또한 google맵과 연동을 통하여 내 주변에 약국의 위치와 지역(동)으로 검색하여 약국 위치를 알 수 있게 함으로서 모든 사람들에 의약품 정보를 언제 어디서나 편리하게 서비스를 제공 하는 것을 목표로 구성하였다. 약국과 의약품 정보를 파싱하기 위해 공공데이터를 이용하고, android studio에 데이터 저장 및 불러와 리뷰와 회원가입/로그인 알림 기능을 구현하고 또한 Google API연동을 통해 GPS를 받아와서 약국을 찾을 수 있도록 한다.

## 1.서론
* 하루가 멀다 하고 새로운 의약품과 건강기능식품이 쏟아지고 있는 요즘, 의약품과 건강기능식품 홍수의 시대라고 해도 과언이 아니다. 수없이 출시되는 의약품과 건강기능식품을 의사처방 없이 쉽게 구입할 수 있어짐에 따라 소비자들의 딜레마 또한 피해갈 수 없다. 잘못된 의약품 선택과 오남용에 대한 우려, 그로 인한 건강악화가 바로 그것이다. <br>
약은 복용시간과 복용기간을 정확하게 지켰을 때 그 효과가 커진다. 그러나 현대인들은 바쁜 생활 속에서 복용중인 약의 복용시간 및 복용기간을 놓치기 쉽다. 때문에 사용자가 설정해놓은 약물 복용시간을 알려주고, 증상에 따른 약 추천 및 가지고 있는 약 사진과 일치하는 약의 정보를 알려줌으로 더욱 편리한 약 복용을 가능하게 하며, GPS를 통해 가까운 약국의 위치를 보여주어 약국 이용을 편리하게 한다.

## 2.본론
### 1.사용자 생성
> 회원가입 및 로그인
  * 아이디로 사용할 이메일, 이름, 전화번호, 비밀번호를 입력한 후 각각의 항목에 대한 빈칸유무, 정규식 등의 유효성 검사를 진행한 후 입력한 값들이 모두 유효하면 Firebase의 Auth와 Firestore에 저장한다. 회원가입이 정상적으로 성공하면 입력한 이메일로 인증 메일이 전송되며, Dialog를 통해 사용자에게 이메일 인증이 필요함을 알려준다. 전송된 메일을 통해 이메일 인증을 완료하지 않으면 이메일과 비밀번호 값이 일치해도 로그인에 성공할 수 없다. 이메일 인증이 완료되어야 로그인을 시도할 수 있으며 로그인이 성공하면 메뉴 화면으로 전환된다. 계정을 통한 로그인 외에 구글 아이디를 이용한 로그인 방법을 추가하였다. 사용자는 자신의 구글 아이디를 이용하여 로그인을 진행할 수 있다. <br>
로그인을 진행하지 않아도 어플을 사용할 수 있으나 게시판 이용 및 회원정보 열람은 로그인에 성공하지 못하면 이용할 수 없다. <br> <img src="https://user-images.githubusercontent.com/62936197/152633276-0c1fa2f1-55e1-426f-96dc-107aaa9cfa35.png" width="130" height="150"> <img src="https://user-images.githubusercontent.com/62936197/152633274-acfc9aad-873d-42d0-b7b4-826db725cb5a.png" width="250" height="150">  <br>
> 회원정보 수정
  * 계정을 생성하여 어플에 성공적으로 로그인을 한 사용자는 ‘마이페이지’탭에서 회원정보를 수정할 수 있다. 다만, 탭에 방문할 때에는 이메일을 인증이 필요하며, 입력한 값이 현재 로그인 중인 사용자의 이메일 값과 일치할 경우 회원정보 및 정보 수정을 위한 버튼을 보여준다. 이메일 값이 일치하지 않을 경우 회원정보가 보여지지 않는다.
회원정보는 Firestore에 저장된 이메일, 이름, 전화번호, 비밀번호를 보여주되 아이디로 사용되는 이메일은 수정이 불가하며 그 외의 항목은 옆에 있는 수정버튼 클릭 시 Dialog로 수정할 값을 입력할 수 있다. 수정할 값들 또한 회원가입 시와 동일하게 유효성 검사를 진행하고, 입력한 값들이 모두 유효하면 Firebase의 Auth와 Firestore에 변경한 값으로 데이터를 업데이트 한다.
<br> <img src="https://user-images.githubusercontent.com/62936197/152633338-f0150efe-b2a9-4693-b8a6-31bf12546a54.png" width="130" height="150"> <br>
### 2.약국 검색
> 위치 관련 퍼미션 허용과 GPS 활성화
  * Google Map이 실행되면 초기 위치값을 서울역으로 설정해두었기 때문에 카메라가 초기 위치로 이동된 지도가 보여진다. 앱을 처음 실행한 경우에는 사용자에게 위치 퍼미션을 요청하여 허용 여부를 묻는데, 허용이 되었으면 GPS활성화 여부를 확인하고 활성화 위치 업데이트를 시작한다. GPS가 활성화 되지 않았으면 앱을 사용하기 위해서는 위치 서비스가 필요하며 위치 설정 수정을 묻는 dialog가 뜬다. <br> 사용자가 위치 퍼미션을 거부한 경우는 단순히 거부를 눌렀을 때와 “다시 묻지 않음”을 선택하고 거부를 누른 경우로 나뉜다. 두 번째 경우는 Snackbar로 퍼미션이 거부됨과 활성화를 위해서는 ‘설정-앱 정보’에서 퍼미션을 허용해야함을 알리고 확인을 누르면 Activity가 종료된다. 사용자가 직접 ‘설정’탭에서 허용을 한 후에 앱을 실행해야 위치 업데이트를 시작한다. 
> 사용자의 현재 위치 확인
  * 위의 과정을 마친 후에는 현재 위치를 지오코더를 이용해서 GPS를 주소로 변환한다. 주소를 정상적으로 발견하였다면 경도와 위도를 받아온다. 현재 위치 버튼을 클릭하면 사용자의 위치에 마커가 생성되고 카메라를 현재 위치로 함께 이동시킨다. 마커를 터치하면 주소와 위도, 경도 값을 확인할 수 있다.
지오코더로 주소를 변환하는 과정에서, 네트워크 문제가 발생했거나 정상적으로 주소를 발견하지 못했을 경우에는 Toast로 문제점을 띄운다. 
> 현재 위치를 기반으로 주변 약국 검색
  * 주변 약국 검색 기능은 Google에서 제공하는 Places API web Service를 활용하였다. Google에서 지정한 places중에서 활용이 가능하며 약국의 위치 정보가 필요하기 때문에 'PHARMACY'를 이용하였다. 앞서 받아온 현재 위치를 기준으로 반경 2500m에 위치한 약국을 지도에 마커로 표시했으며 현재 위치 마커와 구분하기 위해서 약국 위치 마커의 아이콘을 바꾸었다. 마커 표시는 ‘내 주변 약국 찾기’버튼을 누르면 실행되며 현재 위치가 변한 후에는 버튼을 다시 눌러주면 지도를 clear시킨 후에 주변 약국을 다시 검색한 후에 띄운다. <br> <img src="https://user-images.githubusercontent.com/62936197/152633364-206fe0da-3665-4b4a-924b-fe1717f7abb0.png" width="250" height="150"> <br>
> ‘동이름’으로 약국 검색
  * ‘건강보험심사평가원’에서 제공하는 ‘약국정보서비스’ 공공데이터 api를 활용하여 약국의 정보를 사용자에게 알려준다. 검색창에서 ‘동이름’을 검색하면 해당하는 ‘동’에 위치한 약국의 이름과 주소, 전화번호를 SlidingDrawer에 띄운다. 공간 활용도를 높이기 위해서 검색 외의 활동을 할때는 지도를 완전히 가리지 않고, 검색한 후에 버튼을 슬라이딩하면 검색 결과를 확인할 수 있게 해두었다. <br> <img src="https://user-images.githubusercontent.com/62936197/152633285-b2ea2849-1163-42bf-85e2-abd62cd240ea.png" width="130" height="150"> <br>
### 3.사용자 후기 게시판
> 게시글 등록
  * 사용자 후기 게시판은 로그인이 성공한 후 사용자 후기 게시판을 이용할 수 있다. 만약 로그인이 성공하였다면 게시글 입력 및 다른 사용자들의 약 복용 후기를 볼 수 있다. <br> 게시글을 등록할 때 게시글의 제목 및 내용을 모두 입력해야 게시글을 등록할 수 있으며, 이 때 사용자가 등록한 게시물은 작성날짜와 함께 Firebase에 저장된다.  이렇게 등록한 게시글은 로그인 시 등록했던 사용자 이메일 정보를 통해 게시글의 작성자를 구분할 수 있다. 또한 등록된 게시글은 일부 내용만 보여주며 해당 게시글을 클릭 시 전체적인 내용을 볼 수 있는 페이지로 넘어간다. <br> <img src="https://user-images.githubusercontent.com/62936197/152633375-5856b998-9223-4e24-9feb-530ef0c9d9da.png" width="550" height="150"> <br>
> 게시글 수정 및 삭제
  * 한 사용자가 등록한 게시글은 해당 사용자만 수정 및 삭제가 가능하도록 버튼을 보여준다. 게시글 목록에서의 popup 메뉴를 이용하여 수정 및 삭제가 가능하며 게시글을 클릭하여 넘어가는 창에서도 버튼을 통해 수정 및 삭제 기능을 실행할 수 있다. 현재 로그인한 사용자와 Firebase에 등록된 게시글의 등록자가 동일하다면 게시글 목록에서 popup메뉴를 보여주며, 해당 게시물을 클릭하면 나오는 수정 및 삭제 버튼을 이용하여 수정 및 삭제가 가능하다. 이 때, 수정된 게시글의 내용은 Firebase와 리뷰 목록 창에도 update된다. 게시글의 삭제 버튼을 클릭 시 삭제를 재확인하는 Dialog창을 보여준다. 이때, ‘예’ 버튼 클릭 시 해당 게시글은 Firebase와 리뷰 목록에서 완전히 삭제된다. <br> <img src="https://user-images.githubusercontent.com/62936197/152633376-e7412a67-7a7e-4a1e-b5c3-650dc49e163c.png" width="550" height="150"> <br>
### 4.약 검색
> 약 이름으로 검색
  * 약 이름으로 검색하는 기능은 ‘식품 의약품 안전처’ 에서 제공하는 ‘의약품 낱알식별정보(DB) 서비스와 ’식품 의약품 안전처, 식품의약품안전평가원‘에서 제공하는 ’의약품 제품 허가정보 서비스‘ 공공데이터를 활용한다. 공공데이터포털 사이트에서 서비스 인증 Key를 신청 후 활용 허가를 받아 사용한다. <br>
검색창에 알고 싶은 약의 이름을 검색하면 해당 약에 대한 검색 결과들이 나온다. 이때, 해당하는 약을 클릭하면 상세 정보 페이지로 넘어가 그 약의 상세 정보를 볼 수 있다. 이러한 약 검색은 XML형식으로 제공되는 ‘의약품 낱알식별정보(DB) 서비스’를 이용하여 검색 창에서 검색된 약의 이름을 요청변수로 넘겨주어 해당하는 약의 이름이 포함된 결과를 공공데이터를 파싱을 통해  보여주며, 상세정보 페이지는 ‘의약품 제품 허가정보 서비스’를 이용한다. 이 공공데이터 또한 XML방식으로 제공되며 선택한 약의 이름을 자동으로 요청변수로 넘겨주어 검색하게 한다. XML 데이터 중 사용자들에게 제공하고자 하는 정보들을 추출해 낸 후, 그 정보들을 띄운다. <br> <img src="https://user-images.githubusercontent.com/62936197/152633282-ae2b88d6-fec5-4167-aa25-dee62466efca.png" width="250" height="150"> <br>

> 약 모양으로 검색
  * 약 모양으로 검색하는 기능 또한 약 이름으로 검색과 동일한 공공데이터를 이용한다. 모양으로 검색하는 방식은 2가지로 나누었는데 외형적 특징을 선택하여 해당하는 의약품을 검색하는 방법과 의약품 앞, 뒤로 쓰인 식별 표시를 검색하는 방법이 있다. 두 방식 모두 CSV형식으로 제공하는 ‘의약품 낱알식별정보(DB)' 파일을 JSON 형식으로 변환한 후에 파싱을 하여 사용했다. 필요한 KEY값인 색상, 모양, 제형, 앞의 식별 표시, 뒤의 식별 표시와 그에 해당하는 VALUE를 받아왔다. 
우선, 첫 번째 방법은 사용자가 검색하려는 의약품의 색상, 모양, 제형 버튼을 각각 클릭하고 검색 버튼을 누르면 해당하는 의약품들을 Recyclerview의 list형식으로 scroll하며 볼 수 있다. 다른 방법은 의약품에 있는 식별 표시를 입력하고 검색 버튼을 누르면 위와 같은 방식으로 해당하는 의약품들을 확인할 수 있다. 두 방식 모두 각각의 카테고리를 모두 선택하지 않고 검색버튼을 눌러도 조건에 맞는 결과를 얻을 수 있다. 상세 보기 페이지는 ‘약 이름으로 검색’에서 설명한 XML 데이터를 파싱해서 상세 정보를 보여주는 방식과 동일하게 적용된다. <br> <img src="https://user-images.githubusercontent.com/62936197/152633284-7f7474a9-820c-4841-9d9a-675726033f4c.png" width="250" height="150"> <br>

### 5.부작용 정보 검색
* 노인, 임산부 금기, 어린이의 세가지 항목을 생성하여 각 항목을 클릭한 후 의약품 이름을 입력하면 부작용 정보를 보여준다. <br> <img src="https://user-images.githubusercontent.com/62936197/152633436-975f0c60-cfe8-4530-a7a3-84b060a2710a.png" width="250" height="150"> <br>

### 6.증상으로 검색
* 감기, 근육통 등 8가지의 항목을 생성하여 각 항목을 클릭하면 해다 증상에 맞는 의약품은 '아이큐비아'에서 제공한 의약품 판매순위에 따라 보여준다. <br> <img src="https://user-images.githubusercontent.com/62936197/152633433-cad4cf81-af55-48f6-a6ec-5a2c6eba36e9.png" width="250" height="150"> <br>

### 7.약 복용시간 알림
> 알림설정
  * 알림기능은 알림데이터를 저장하기 위해서 SQLite를 이용한다. floatingActionButton을 누르면 알림을 setting 해줄 수 있는 layout으로 넘어가고 timepicker에서 입력한 값과 edittext를 입력한 값을 가져와 contentvalues를 이용해 저장을 한다. alarmManager와 pendingIntent를 이용하여 알람설정을 하고 requestcode값과 약 이름을 intent.putExtra를 이용해서 AlarmReceiver로 넘겨준다. AlarmReceiver로 넘어가면 getExtra를 이용해 앞서 넣어주었던 requestcode값과 약 이름을 받아와 pendingIntent에 넣어준다. 그러면 설정한 notification의 형태에 맞게 설정한 시간이 되면 edittext에 입력한 약이름과 함께 약을 복용하라는 푸시알림이 진동과 함께 울린다. 알림 데이터는 Adapter를 이용하여 listview위에 띄운다. 
  * 알림을 설정할 때 pendingIntent를 이용하는데 여기에서 requestcode값을 다르게 하면 여러개의 푸시알림이 울린다. 알림을 구분해주기위해 설정한 시값과 분값을 더한값으로 requestcode를 구분지었다. 그리고 설정한 시,분,약이름 데이터를 SQLite에 저장하여, 알림을 설정한 시간이 되면 푸시알림이 오도록 한다. <br> <img src="https://user-images.githubusercontent.com/62936197/152633466-2395fb17-fc3e-41ef-b4e1-17ae2de3a114.png" width="550" height="150"> <br>
> 알림삭제
  * listview에 있는 알림들중 하나를 길게 누르면 database의 id값을 가져온 후 지운다. 그리고 pendingIntent의 requestcode에 설정한 알림의 hour값과 minute값을 넣고 alarmmanager.cancel을 하여 설정했던 pendingintent를 삭제한다. <br> <img src="https://user-images.githubusercontent.com/62936197/152633471-dad356f5-bd6c-4ca1-bb4a-3c7c4d62e31c.png" width="550" height="150"> <br>

## 3.결론
* 편의점에서도 약을 손쉽게 구매할 수 있는 요즘 편의점 직원은 의약품에 대한 전공을 가지고 있는 약사가 아니어서 약에 대한 효능과 부작용을 잘 알고 있지 않다. 그렇기 때문에 약쏙 어플리케이션으로 합리적인 의약품을 선택할 수 있게 도와준다. 이와 더불어 집에 있는 의약품이 어떤 효능과 부작용을 가지고 있는지 알지 못할 때, 약의 모양과 이름을 통한 검색으로 자신에게 맞는 의약품을 선택할 수 있게 도와준다는 기대효과를 가져온다.
